trigger:
- main

pool:
  vmImage: ubuntu-latest
variables:
  resourceGroupName: "azure-lcm"
  location: "westeurope"
  workloadName: "azlcm"
  workloadEnv: "ut"
  appServiceName: "$(workloadName)app$(workloadEnv)"
  keyvaultUri: "https://$(workloadName)keyvault$(workloadEnv).vault.azure.net/"
  serviceConnectionName: "MCAPS-Hybrid-REQ-38041-2022-MoimHossain"
  azureDevOpsOrgName: "moim"

stages:
  # - stage: CreateInfrastructure
  #   displayName: 'Create Infrastructure'    
  #   jobs:
  #   - job: CreateInfra
  #     displayName: 'Create infrastructure'
  #     steps:
  #     - checkout: self
  #     - task: AzureCLI@2
  #       displayName: 'Deploy infrastructure'
  #       inputs:
  #         azureSubscription: $(serviceConnectionName)
  #         scriptType: bash
  #         scriptPath: 'CBSP-Azure/CustomerSolutions/Foundation/LCMDashboard/Management/LcmDashboard/infra/build-infra.sh'
  #         workingDirectory: CBSP-Azure/CustomerSolutions/Foundation/LCMDashboard/Management/LcmDashboard/infra
  #       env:
  #         resourceGroupName: $(resourceGroupName)
  #         location: $(location)
  #         workloadName: $(workloadName)
  #         workloadEnv: $(workloadEnv)
      


  - stage: PublishApplication
    displayName: 'Build and Publish Application'
    #dependsOn: CreateInfrastructure
    #condition: succeeded()
    jobs:
    - job: BuildAndPublish
      displayName: 'Build and Publish Application'
      steps:
      - checkout: self
      - task: UseDotNet@2
        displayName: 'Install .NET SDK'
        inputs:
          packageType: 'sdk'
          version: '8.0.x'

      - script: |
          cd  /home/vsts/work/1/s/CBSP-Azure/CustomerSolutions/Foundation/LCMDashboard/Management/LcmDashboard/Azure.Lcm.Web/
          dotnet publish "Azure.Lcm.Web.csproj" -c "Release" -o "$(Build.ArtifactStagingDirectory)/published-content-$(Build.BuildId)"
        displayName: 'Build application'

      - task: ArchiveFiles@2
        displayName: 'Zip application'
        inputs:
          rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/published-content-$(Build.BuildId)"
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
          replaceExistingArchive: true 
 
      - task: PublishPipelineArtifact@1
        displayName: 'Publish Artifact' 
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
          artifact: 'drop'
          publishLocation: 'pipeline'

      - task: AzureWebApp@1
        displayName: 'Deploy web app'
        inputs:
          azureSubscription: $(serviceConnectionName)
          appType: 'webApp'
          appName: $(appServiceName)
          package: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
          appSettings: '-PROCESS_AZURE_FEED "true" -PROCESS_AZURE_POLICY "true" -PROCESS_AZURE_SERVICE_HEALTH "true"  -GITHUB_PAT "XXX" -AZURE_KEY_VAULT_URI "$(keyvaultUri)" -AZURE_POLICY_URI_BASE "https://api.github.com/repos/azure/azure-policy/contents/" -AZURE_POLICY_PATH "built-in-policies/policyDefinitions" -AZURE_UPDATE_FEED_URI "https://www.microsoft.com/releasecommunications/api/v2/azure/rss" -AZURE_STORAGE_ACCOUNT_NAME "XXX" -AZURE_STORAGE_FEED_TABLE_NAME "azupdatefeed" -AZURE_STORAGE_POLICY_TABLE_NAME "azpolicy" -AZURE_STORAGE_SVC_HEALTH_TABLE_NAME "azsvchealth" -AZURE_STORAGE_COFIG_CONTAINER "az-lcm-configs" -AZURE_OPENAI_GPT_DEPLOYMENT_ID "gpt-4o" -AZURE_DEVOPS_ORGNAME "$(azureDevOpsOrgName)" -AZURE_DEVOPS_USE_PAT "true" -AZURE_DEVOPS_PAT "XXX"'
          deploymentMethod: 'zipDeploy'




  # - stage: DeleteOldContainers
  #   displayName: 'Delete old containers'
  #   dependsOn: BuildContainerImage
  #   condition: succeeded()
  #   jobs:
  #   - job: DeleteOldContainers
  #     displayName: 'Delete old containers'
  #     steps:
  #     - checkout: self
  #     - task: AzureCLI@2
  #       displayName: 'Delete-Old-Job'
  #       inputs:
  #         azureSubscription: $(serviceConnectionName)
  #         scriptType: bash
  #         scriptPath: 'infra/delete-old-containers.sh'
  #       env:
  #         resourceGroupName: $(resourceGroupName)

  # - stage: ExecuteJob
  #   displayName: 'Execute container'
  #   dependsOn: BuildContainerImage
  #   condition: succeeded()
  #   jobs:
  #   - job: ExecuteJob
  #     displayName: 'Execute container'
  #     steps:
  #     - checkout: self
  #     - task: AzureCLI@2
  #       displayName: 'Run-Job'
  #       inputs:
  #         azureSubscription: $(serviceConnectionName)
  #         scriptType: bash
  #         scriptPath: 'infra/execute-job.sh'
  #       env:
  #         resourceGroupName: $(resourceGroupName)
  #         location: $(location)
  #         workloadName: $(workloadName)
  #         workloadEnv: $(workloadEnv)
  #         keyvaultUri: $(keyvaultUri)
  #         registryURI: $(registryURI)
  #         containerName : $(containerName)
  #         imageName: $(imageName)
  #         imageTag: $(Build.BuildId)
  #         GTIHUB_PAT: $(GTIHUB_PAT)
  #         STORAGE_ACCOUNT: $(workloadName)storageacc$(workloadEnv)  
  #         AZURE_DEVOPS_ORGNAME: $(azureDevOpsOrgName)
  #         AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_PAT)
